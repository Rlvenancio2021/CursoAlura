USE VENDAS_SUCOS;

CREATE TABLE TB_FATURAMENTO(
DATA_VENDA DATE NULL,
TOTAL_VENDA FLOAT);

SELECT * FROM TB_FATURAMENTO;

SELECT * FROM NOTAS;
SELECT * FROM ITENS_NOTAS;
SELECT * FROM CLIENTES;
SELECT * FROM VENDEDORES;
SELECT CODIGO FROM PRODUTOS;

/* Inserindo primeiras informações de NFs e Itens */
INSERT INTO NOTAS(NUMERO, DATA_VENDA, CPF, MATRICULA, IMPOSTO)
VALUES('0100', '2022-02-14', '1471156710', '235', 0.10);
INSERT INTO ITENS_NOTAS(NUMERO, CODIGO, QUANTIDADE, PRECO)
VALUES('0100','1000889',100, 10);
INSERT INTO ITENS_NOTAS(NUMERO, CODIGO, QUANTIDADE, PRECO)
VALUES('0100','1002334',100, 10);

INSERT INTO NOTAS(NUMERO, DATA_VENDA, CPF, MATRICULA, IMPOSTO)
VALUES('0101', '2022-02-14', '1471156710', '235', 0.10);
INSERT INTO ITENS_NOTAS(NUMERO, CODIGO, QUANTIDADE, PRECO)
VALUES('0101','1000889',100, 10);
INSERT INTO ITENS_NOTAS(NUMERO, CODIGO, QUANTIDADE, PRECO)
VALUES('0101','1002334',100, 10);

INSERT INTO NOTAS(NUMERO, DATA_VENDA, CPF, MATRICULA, IMPOSTO)
VALUES('0102', '2022-02-14', '1471156710', '235', 0.10);
INSERT INTO ITENS_NOTAS(NUMERO, CODIGO, QUANTIDADE, PRECO)
VALUES('0102','1000889',100, 10);
INSERT INTO ITENS_NOTAS(NUMERO, CODIGO, QUANTIDADE, PRECO)
VALUES('0102','1002334',100, 10);

SELECT * FROM
NOTAS A INNER JOIN ITENS_NOTAS B
ON A.NUMERO = B.NUMERO;

/* Instrução para visualisar o total de vendas realizadas */
SELECT A.DATA_VENDA, SUM(B.QUANTIDADE * B.PRECO) AS TOTAL_VENDA FROM
NOTAS A INNER JOIN ITENS_NOTAS B
ON A.NUMERO = B.NUMERO
GROUP BY A.DATA_VENDA;

/* Incluindo informação de totais na tabela de faturamento*/
INSERT INTO TB_FATURAMENTO
SELECT A.DATA_VENDA, SUM(B.QUANTIDADE * B.PRECO) AS TOTAL_VENDA FROM
NOTAS A INNER JOIN ITENS_NOTAS B
ON A.NUMERO = B.NUMERO
GROUP BY A.DATA_VENDA;

SELECT * FROM TB_FATURAMENTO;

/* Inclusão de novo faturamento NF 103*/
INSERT INTO NOTAS(NUMERO, DATA_VENDA, CPF, MATRICULA, IMPOSTO)
VALUES('0103', '2022-02-14', '1471156710', '235', 0.10);
INSERT INTO ITENS_NOTAS(NUMERO, CODIGO, QUANTIDADE, PRECO)
VALUES('0103','1000889',100, 10);
INSERT INTO ITENS_NOTAS(NUMERO, CODIGO, QUANTIDADE, PRECO)
VALUES('0103','1002334',100, 10);
DELETE FROM TB_FATURAMENTO;
INSERT INTO TB_FATURAMENTO
SELECT A.DATA_VENDA, SUM(B.QUANTIDADE * B.PRECO) AS TOTAL_VENDA FROM
NOTAS A INNER JOIN ITENS_NOTAS B
ON A.NUMERO = B.NUMERO
GROUP BY A.DATA_VENDA;
SELECT * FROM TB_FATURAMENTO;

/* Inclusão de novo faturamento NF 104*/
INSERT INTO NOTAS(NUMERO, DATA_VENDA, CPF, MATRICULA, IMPOSTO)
VALUES('0104', '2022-02-14', '1471156710', '235', 0.10);
INSERT INTO ITENS_NOTAS(NUMERO, CODIGO, QUANTIDADE, PRECO)
VALUES('0104','1000889',100, 10);
INSERT INTO ITENS_NOTAS(NUMERO, CODIGO, QUANTIDADE, PRECO)
VALUES('0104','1002334',100, 10);
DELETE FROM TB_FATURAMENTO;
INSERT INTO TB_FATURAMENTO
SELECT A.DATA_VENDA, SUM(B.QUANTIDADE * B.PRECO) AS TOTAL_VENDA FROM
NOTAS A INNER JOIN ITENS_NOTAS B
ON A.NUMERO = B.NUMERO
GROUP BY A.DATA_VENDA;
SELECT * FROM TB_FATURAMENTO;

/* Construção da TRIGGRES */

DELETE FROM ITENS_NOTAS;
DELETE FROM NOTAS;
DELETE FROM TB_FATURAMENTO;

DELIMITER // /* criar um delimitador que indica o final da TRIGGER de caracter */
CREATE TRIGGER TG_CALCULA_FATURAMENTO_INSERT AFTER INSERT ON ITENS_NOTAS
FOR EACH ROW
BEGIN /* incluir a instrução de calcular o faturamento e carregar na tb_faturamento */
  DELETE FROM TB_FATURAMENTO;
  INSERT INTO TB_FATURAMENTO
  SELECT A.DATA_VENDA, SUM(B.QUANTIDADE * B.PRECO) AS TOTAL_VENDA FROM
  NOTAS A INNER JOIN ITENS_NOTAS B
  ON A.NUMERO = B.NUMERO
  GROUP BY A.DATA_VENDA;
END;

SELECT * FROM TB_FATURAMENTO;

INSERT INTO NOTAS(NUMERO, DATA_VENDA, CPF, MATRICULA, IMPOSTO)
VALUES('0100', '2022-02-14', '1471156710', '235', 0.10);
INSERT INTO ITENS_NOTAS(NUMERO, CODIGO, QUANTIDADE, PRECO)
VALUES('0100','1000889',100, 10);
INSERT INTO ITENS_NOTAS(NUMERO, CODIGO, QUANTIDADE, PRECO)
VALUES('0100','1002334',100, 10);

INSERT INTO NOTAS(NUMERO, DATA_VENDA, CPF, MATRICULA, IMPOSTO)
VALUES('0101', '2022-02-14', '1471156710', '235', 0.10);
INSERT INTO ITENS_NOTAS(NUMERO, CODIGO, QUANTIDADE, PRECO)
VALUES('0101','1000889',100, 10);
INSERT INTO ITENS_NOTAS(NUMERO, CODIGO, QUANTIDADE, PRECO)
VALUES('0101','1002334',100, 10);

INSERT INTO NOTAS(NUMERO, DATA_VENDA, CPF, MATRICULA, IMPOSTO)
VALUES('0102', '2022-02-14', '1471156710', '235', 0.10);
INSERT INTO ITENS_NOTAS(NUMERO, CODIGO, QUANTIDADE, PRECO)
VALUES('0102','1000889',100, 10);
INSERT INTO ITENS_NOTAS(NUMERO, CODIGO, QUANTIDADE, PRECO)
VALUES('0102','1002334',100, 10);

INSERT INTO NOTAS(NUMERO, DATA_VENDA, CPF, MATRICULA, IMPOSTO)
VALUES('0103', '2022-02-14', '1471156710', '235', 0.10);
INSERT INTO ITENS_NOTAS(NUMERO, CODIGO, QUANTIDADE, PRECO)
VALUES('0103','1000889',100, 10);
INSERT INTO ITENS_NOTAS(NUMERO, CODIGO, QUANTIDADE, PRECO)
VALUES('0103','1002334',100, 10);

INSERT INTO NOTAS(NUMERO, DATA_VENDA, CPF, MATRICULA, IMPOSTO)
VALUES('0104', '2022-02-14', '1471156710', '235', 0.10);
INSERT INTO ITENS_NOTAS(NUMERO, CODIGO, QUANTIDADE, PRECO)
VALUES('0104','1000889',100, 10);
INSERT INTO ITENS_NOTAS(NUMERO, CODIGO, QUANTIDADE, PRECO)
VALUES('0104','1002334',100, 10);

INSERT INTO NOTAS(NUMERO, DATA_VENDA, CPF, MATRICULA, IMPOSTO)
VALUES('0105', '2022-02-15', '1471156710', '235', 0.10);
INSERT INTO ITENS_NOTAS(NUMERO, CODIGO, QUANTIDADE, PRECO)
VALUES('0105','1000889',100, 10);
INSERT INTO ITENS_NOTAS(NUMERO, CODIGO, QUANTIDADE, PRECO)
VALUES('0105','1002334',100, 10);